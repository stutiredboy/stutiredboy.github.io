<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>记一次 TiDB 时区设置异常问题排查</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="记一次 TiDB 时区设置异常问题排查"/>
            <meta property="og:url" content="https://blog.chenxiaosheng.com/posts/2019-10-12/tidb-time_zone-settings.html"/>
            <meta property="og:description" content="两个配置一模一样的 TiDB 集群，在执行 SELECT NOW(); 操作的时候出现了不一样的结果，A 集群的时间与系统时间一致，B 集群的时间比系统时间少了 8 小时。OS、TiDB 配置是统一管理的，究竟是什么原因导致的呢？"/>

    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.1.1/css/bootstrap.min.css">
    <link href="https://cdn.staticfile.org/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://blog.chenxiaosheng.com/theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.chenxiaosheng.com/theme/css/style.css">
    <!--[if lt IE 9]>
        <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <![endif]-->
    <!--[if gte IE 9]><!-->
        <script src="https://cdn.staticfile.org/jquery/3.3.1/jquery.min.js"></script>
    <!--<![endif]-->

        <link href="https://blog.chenxiaosheng.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="碎碎念 ATOM Feed"/>

    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-30723232-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <!-- I don't need this //by tiredboy
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>-->
            <a href="https://blog.chenxiaosheng.com" class="navbar-brand">碎碎念</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-md-9 col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.chenxiaosheng.com/posts/2019-10-12/tidb-time_zone-settings.html"
                       rel="bookmark"
                       title="Permalink to 记一次 TiDB 时区设置异常问题排查">
                        记一次 TiDB 时区设置异常问题排查
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="published">
      <i class="icon-calendar"></i>2019-10-12 22:27
    </span>



<i class="icon-tags"></i>
	<a href="https://blog.chenxiaosheng.com/tag/dm.html">dm</a>
        /
	<a href="https://blog.chenxiaosheng.com/tag/mysql.html">mysql</a>
        /
	<a href="https://blog.chenxiaosheng.com/tag/tidb.html">tidb</a>
        /
	<a href="https://blog.chenxiaosheng.com/tag/pingcap.html">pingcap</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>收到同事的反馈，两个配置一模一样的 TiDB 集群，在执行 <code>SELECT NOW();</code> 操作的时候出现了不一样的结果，A 集群的时间与系统时间一致，B 集群的时间比系统时间少了 8 小时。</p>
<p><img alt="请在这里输入图片描述" src="/static/20191012150952.png"></p>
<p>由于我们的 OS、TiDB 配置是统一管理的，所以我并不怀疑是因为两个集群当前配置不一样导致的。第一反应肯定是因为在 TiDB 启动之前用了错误的时区（UTC），然后 TiDB 引用了错误的时区导致的这个时间问题。根据常规经验，重启一下 TiDB 进程问题应该能解决。</p>
<p>然而这一次失望了，重启 TiDB 之后，并没有发生什么变化。跟同事要了服务器信息，直接登录到机器上看一下吧。以下是整体的排查过程。</p>
<h3>先确认是不是，再查为什么</h3>
<p>首先还是确认是不是有这个问题（再研究为什么），根据<a href="https://pingcap.com/docs-cn/v3.0/how-to/configure/time-zone/#%E6%97%B6%E5%8C%BA%E6%94%AF%E6%8C%81">官方文档</a>，检查了 <code>time_zone</code> 信息，并没有发现异常，有问题的集群和没问题的集群配置也是完全一样的。</p>
<div class="highlight"><pre><span></span><code><span class="c">mysql</span><span class="nv">&gt;</span><span class="c"> SELECT @@global</span><span class="nt">.</span><span class="c">time_zone</span><span class="nt">,</span><span class="c"> @@session</span><span class="nt">.</span><span class="c">time_zone;</span>
<span class="nb">+--------------------+---------------------+</span><span class="c"></span>
<span class="c">| @@global</span><span class="nt">.</span><span class="c">time_zone | @@session</span><span class="nt">.</span><span class="c">time_zone |</span>
<span class="nb">+--------------------+---------------------+</span><span class="c"></span>
<span class="c">| SYSTEM             | SYSTEM              |</span>
<span class="nb">+--------------------+---------------------+</span><span class="c"></span>
<span class="c">1 row in set (0</span><span class="nt">.</span><span class="c">01 sec)</span>

<span class="c">mysql</span><span class="nv">&gt;</span><span class="c"> SHOW GLOBAL VARIABLES LIKE &#39;%time_zone&#39;;</span>
<span class="nb">+------------------+--------+</span><span class="c"></span>
<span class="c">| Variable_name    | Value  |</span>
<span class="nb">+------------------+--------+</span><span class="c"></span>
<span class="c">| system_time_zone | CST    |</span>
<span class="c">| time_zone        | SYSTEM |</span>
<span class="nb">+------------------+--------+</span><span class="c"></span>
<span class="c">2 rows in set (0</span><span class="nt">.</span><span class="c">00 sec)</span>

<span class="c">mysql</span><span class="nv">&gt;</span><span class="c"></span>
</code></pre></div>

<p>虽然这里没有发现明显问题，但我们还是发现了一个疑点：我们的服务器，不可能会有 <code>CST</code> 这个时区设置（我们用的是 HKT），但 <code>CST</code> 这个很明显不是问题的原因。</p>
<h3>日志是一定要看的</h3>
<p>几乎可以这么说，日志就是为了排查问题而诞生的，任何不能马上判断的问题，都应该去翻一下日志，对服务的健康情况进行判断。因为是时区相关的问题，所以直接对 TiDB 的日志做了一个 <code>fgrep -i timezone tidb.log</code> 的操作，没想到真的发现了错误日志，毫无波折，就是这么惊喜。（TiDB 日志打印出来是完整一行的，以下内容我稍微格式化了一下，转化为真正的换行）：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">019/10/09 16:21:42.111 +08:00</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">ERROR</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">time.go:81</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;locate timezone files failed&quot;</span><span class="o">]</span><span class="w"> </span><span class="err">[]</span><span class="w"> </span><span class="o">[</span><span class="n">stack=&quot;github.com/pingcap/tidb/util/timeutil.InferSystemTZ</span>
<span class="n">/home/jenkins/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb/util/timeutil/time.go:81</span>
<span class="n">github.com/pingcap/tidb/session.writeSystemTZ</span>
<span class="n">/home/jenkins/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb/session/bootstrap.go:786</span>
<span class="n">github.com/pingcap/tidb/session.doDMLWorks</span>
<span class="n">/home/jenkins/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb/session/bootstrap.go:935</span>
<span class="n">github.com/pingcap/tidb/session.bootstrap</span>
<span class="n">/home/jenkins/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb/session/bootstrap.go:290</span>
<span class="n">github.com/pingcap/tidb/session.runInBootstrapSession</span>
<span class="n">/home/jenkins/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb/session/session.go:1541</span>
<span class="n">github.com/pingcap/tidb/session.BootstrapSession</span>
<span class="n">/home/jenkins/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb/session/session.go:1460</span>
<span class="n">main.createStoreAndDomain</span>
<span class="n">/home/jenkins/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb/tidb-server/main.go:205</span>
<span class="n">main.main</span>
<span class="n">/home/jenkins/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb/tidb-server/main.go:171</span>
<span class="n">runtime.main</span>
<span class="n">/usr/local/go/src/runtime/proc.go:200&quot;</span><span class="o">]</span><span class="w"></span>
</code></pre></div>

<p>几乎可以直接肯定是因为这个报错导致的问题了，但还是需要靠撸代码来证明一下的。</p>
<h3>撸代码</h3>
<p>根据上述的错误日志，可以知道最终实际执行出错的函数在 <code>util/timeutil/time.go</code> 的 <code>InferSystemTZ</code> 函数里，我们来看下这个函数做了什么：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// InferSystemTZ reads system timezone from `TZ`, the path of the soft link of `/etc/localtime`. If both of them are failed, system timezone will be set to `UTC`.</span><span class="w"></span>
<span class="c1">// It is exported because we need to use it during bootstap stage. And it should be only used at that stage.</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="nx">InferSystemTZ</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// consult $TZ to find the time zone to use.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// no $TZ means use the system default /etc/localtime.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// $TZ=&quot;&quot; means use UTC.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// $TZ=&quot;foo&quot; means use /usr/share/zoneinfo/foo.</span><span class="w"></span>
<span class="w">  </span><span class="nx">tz</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;TZ&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">err1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">filepath</span><span class="p">.</span><span class="nx">EvalSymlinks</span><span class="p">(</span><span class="s">&quot;/etc/localtime&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">err2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inferTZNameFromFileName</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="nx">err2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">name</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="nx">logutil</span><span class="p">.</span><span class="nx">Logger</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()).</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;infer timezone failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">zap</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err2</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nx">logutil</span><span class="p">.</span><span class="nx">Logger</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()).</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;locate timezone files failed&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">zap</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err1</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="nx">tz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">tz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;UTC&quot;</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">zoneSources</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="nx">source</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">tz</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">tz</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;UTC&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>可以看到，TiDB 设置时区的逻辑是首先获取操作系统的 TZ 变量，再从 <code>/etc/localtime</code> 的实际软链地址提取，最后 fallback 为 UTC。这个逻辑还是与<a href="https://pingcap.com/docs-cn/v3.0/how-to/configure/time-zone/#%E6%97%B6%E5%8C%BA%E6%94%AF%E6%8C%81">官方文档</a>的描述一致的。但是我们的机器上肯定是有 <code>/etc/localtime</code> 文件的，文件肯定也是正确的，为什么会失败呢？再来看一下上述代码里最终分析  <code>/etc/localtime</code> 的函数 <code>inferTZNameFromFileName</code> 都做了什么？</p>
<div class="highlight"><pre><span></span><code><span class="c1">// inferTZNameFromFileName gets IANA timezone name from zoneinfo path.</span><span class="w"></span>
<span class="c1">// TODO: It will be refined later. This is just a quick fix.</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="nx">inferTZNameFromFileName</span><span class="p">(</span><span class="nx">path</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// phase1 only support read /etc/localtime which is a softlink to zoneinfo file</span><span class="w"></span>
<span class="w">  </span><span class="nx">substr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;zoneinfo&quot;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// macOs MoJave changes the sofe link of /etc/localtime from</span><span class="w"></span>
<span class="w">  </span><span class="c1">// &quot;/var/db/timezone/tz/2018e.1.0/zoneinfo/Asia/Shanghai&quot;</span><span class="w"></span>
<span class="w">  </span><span class="c1">// to &quot;/usr/share/zoneinfo.default/Asia/Shanghai&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nx">substrMojave</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;zoneinfo.default&quot;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Index</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">substrMojave</span><span class="p">);</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">path</span><span class="p">[</span><span class="nx">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">substrMojave</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]),</span><span class="w"> </span><span class="kc">nil</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Index</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">substr</span><span class="p">);</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">path</span><span class="p">[</span><span class="nx">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">substr</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]),</span><span class="w"> </span><span class="kc">nil</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;path %s is not supported&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>代码的注释里明确写了<strong>只支持 /etc/localtime 为软链接</strong>，代码的逻辑也是通过截取 <code>/etc/localtime</code> 软链指向的具体文件路径来获得时区信息。看一下我们服务器上的这个文件：</p>
<div class="highlight"><pre><span></span><code>$ ls -alh /etc/localtime
-rw-r--r-- <span class="m">1</span> root root <span class="m">1</span>.2K 10月 <span class="m">12</span> <span class="m">10</span>:11 /etc/localtime
</code></pre></div>

<p>果然是一个文件而不是一个软链接。这下又带来了两个疑问：</p>
<ol>
<li>如果我改成软链再重启 TiDB 能不能解决问题呢？实践证明，不能解决。这里不再赘述。</li>
<li>函数逻辑很明确是 fallback 了 UTC，根据 <code>SELECT NOW();</code> 早了 8 小时也可以确认是 UTC，可为什么 <code>system_time_zone</code> 是 CST 呢？</li>
</ol>
<h4>看到的（CST）和实际的（UTC）不一样？</h4>
<p>TiDB 在拿不到正确的时区，回落至 UTC 时，最终 UTC 是怎么设置的呢？我们再来看一下上面的错误日志：</p>
<div class="highlight"><pre><span></span><code><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">pingcap</span><span class="o">/</span><span class="n">tidb</span><span class="o">/</span><span class="k">session</span><span class="p">.</span><span class="n">writeSystemTZ</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jenkins</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">release_tidb_3</span><span class="mf">.0</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">pingcap</span><span class="o">/</span><span class="n">tidb</span><span class="o">/</span><span class="k">session</span><span class="o">/</span><span class="n">bootstrap</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">786</span><span class="w"></span>
</code></pre></div>

<p>在 <code>session/bootstrap.go</code> 我们找到：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// writeSystemTZ writes system timezone info into mysql.tidb</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="nx">writeSystemTZ</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="nx">Session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">sql</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">`INSERT HIGH_PRIORITY INTO %s.%s VALUES (&quot;%s&quot;, &quot;%s&quot;, &quot;TiDB Global System Timezone.&quot;) ON DUPLICATE KEY UPDATE VARIABLE_VALUE=&quot;%s&quot;`</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">mysql</span><span class="p">.</span><span class="nx">SystemDB</span><span class="p">,</span><span class="w"> </span><span class="nx">mysql</span><span class="p">.</span><span class="nx">TiDBTable</span><span class="p">,</span><span class="w"> </span><span class="nx">tidbSystemTZ</span><span class="p">,</span><span class="w"> </span><span class="nx">timeutil</span><span class="p">.</span><span class="nx">InferSystemTZ</span><span class="p">(),</span><span class="w"> </span><span class="nx">timeutil</span><span class="p">.</span><span class="nx">InferSystemTZ</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="nx">mustExecute</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">sql</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>TiDB 首次启动时，拿到时区信息后，将时区信息写到了 mysql.SystemDB.mysql.TiDBTable，也就是 mysql.tidb，其中 <code>VARIABLE_NAME</code> 为 <code>tidbSystemTZ</code>，也即 <code>system_tz</code></p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="c1">// The variable name in mysql.tidb table and it will be used when we want to know</span><span class="w"></span>
<span class="w">  </span><span class="c1">// system timezone.</span><span class="w"></span>
<span class="w">  </span><span class="nx">tidbSystemTZ</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;system_tz&quot;</span><span class="w"></span>
</code></pre></div>

<p>继续直接登录机器看一下这张参数的内容在两个集群中有什么不一样： </p>
<p><img alt="请在这里输入图片描述" src="/static/20191012164104.png"></p>
<p>可以看到，确实是设置了 UTC，那么也可以非常明确是由于这个值引起的了。经过测试，可以通过如下两种方式解决：</p>
<ol>
<li>更新 mysql.tidb 中 system_tz 为正确的时区，如我们这里为 HKT，并重启 tidb-server 进程后，问题可以得到解决。</li>
<li>
<p>根据<a href="https://pingcap.com/docs-cn/v3.0/how-to/configure/time-zone/#%E6%97%B6%E5%8C%BA%E6%94%AF%E6%8C%81">官方文档</a>设置 <code>time_zone</code> 变量，问题可以得到解决。如果有需要，可以把 <code>system_tz</code> 也修改了，tidb-server 不会自行进行调整：</p>
<p><img alt="请在这里输入图片描述" src="/static/20191012165413.png"></p>
</li>
</ol>
<h3>为什么</h3>
<p>到这里，我们可以很明确 TiDB 参数这里导致时间不对的情况了。但是还有几个疑问还没有得到解决：</p>
<ol>
<li>
<p>为什么同样的配置，有一个集群是正常的，一个集群又用了 UTC 呢？</p>
<p>这个情况主要是因为我们的机器有一个初始化的过程，在没有完成初始化的时候，<code>/etc/localtime</code> 确实是一个软链接，并且指向了 <code>/usr/share/zoneinfo/Asia/Hong_Kong</code>，当我们的 tidb-server 进程在这个文件被修改之前启动时，会使用正确的时区。但同时，我们在机器上部署了 puppet 进行统一的配置管理，puppet 会做一个类似 <code>cp /usr/share/zoneinfo/Asia/Hong_Kong /etc/localtime</code> 的操作，将 <code>/etc/localtime</code> 替换为一个文件，这个时候，tidb-server 无法正确分析时区信息，导致 fall back 至 UTC。简单示意如下：
<img alt="请在这里输入图片描述" src="/static/20191012172800.png"></p>
</li>
<li>
<p>为什么 <code>SELECT @@global.time_zone, @@session.time_zone;</code> 看到的是 CST，但不管是我们的机器还是 TiDB 配置文件都没有引用 CST 这个时区，CST 从哪里来的？</p>
<p>属于 tidb-server 的默认行为，tidb-server 初次启动时，会默认设置为 CST。可以参考 <code>session/bootstrap.go</code> 和 <code>sessionctx/variable/sysvar.go</code> 这里不再展开。</p>
</li>
<li>
<p><code>system_tz</code>、<code>@@global.time_zone</code>、<code>@@sessio.time_zone</code> 的关系是什么？<code>system_tz</code> 和 <code>time_zone</code> 两者的生效逻辑是怎样的？</p>
<ul>
<li><code>@@session.time_zone</code> 在新建连接时，值主要依赖于 <code>@@global.time_zone</code>，session 值等同于 global，默认都为 SYSTEM，即 <code>system_tz</code> 值；</li>
<li>如果单独修改了 <code>@@session.time_zone</code> ，则当前连接的 time_zone 以 session 设置为准；</li>
<li>tidb-server 在每次启动的时候会从 mysql.tidb 加载 <code>system_tz</code> 值，并设置系统时区。这也是为什么我们在更新了 <code>system_tz</code> 并重启 tidb-server 后，可以获取到正确时间的原因；</li>
</ul>
<p>tidb-server 启动时通过 mysql.tidb 设置系统时区的相关代码可以在 <code>session/session.go</code> 找到：</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// loadSystemTZ loads systemTZ from mysql.tidb</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="nx">loadSystemTZ</span><span class="p">(</span><span class="nx">se</span><span class="w"> </span><span class="o">*</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">sql</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">`select variable_value from mysql.tidb where variable_name = &#39;system_tz&#39;`</span><span class="w"></span>
<span class="w">  </span><span class="nx">rss</span><span class="p">,</span><span class="w"> </span><span class="nx">errLoad</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">se</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">sql</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">errLoad</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">errLoad</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// the record of mysql.tidb under where condition: variable_name = &quot;system_tz&quot; should shall only be one.</span><span class="w"></span>
<span class="w">  </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rss</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Close</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">logutil</span><span class="p">.</span><span class="nx">Logger</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()).</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;close result set error&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">zap</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}()</span><span class="w"></span>
<span class="w">  </span><span class="nx">req</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rss</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">NewChunk</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rss</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Next</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">req</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">GetRow</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">GetString</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// BootstrapSession runs the first time when the TiDB server start.</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="nx">BootstrapSession</span><span class="p">(</span><span class="nx">store</span><span class="w"> </span><span class="nx">kv</span><span class="p">.</span><span class="nx">Storage</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">domain</span><span class="p">.</span><span class="nx">Domain</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>

<h3>小结</h3>
<ol>
<li>其实还蛮普通的一个问题，只是之前碰到比较多的情况是在环境初始化没完成时就启动服务，导致服务出现状况。这次 TiDB 这里刚好反过来，环境初始化未操作之前反而是正常的，初始化之后异常了；</li>
<li>问题的线索其实完完整整的保存在了日志中，流程是否有可以优化的空间有待考证商榷，但日志在排查问题的时候是一定要首先关注的；</li>
<li>
<p><code>/etc/localtime</code> 直接使用文件不是一个合理的方式，TZ 环境变量的优先级也高于 <code>/etc/localtime</code>。这个可以参考 <a href="http://man7.org/linux/man-pages/man5/localtime.5.html">man 文档</a>：</p>
<p><code>Because the timezone identifier is extracted from the symlink target 
name of /etc/localtime, this file may not be a normal file or
hardlink.</code></p>
</li>
</ol>
                    <h3 class="icon-hand-right"> 您可能还喜欢以下文章</h3>
                    </br>
                    <ul>
                            <li><a href="https://blog.chenxiaosheng.com/posts/2022-03-29/cgroups-hyperthreading.html">当 cgroups 碰上超线程</a></li>
                            <li><a href="https://blog.chenxiaosheng.com/posts/2019-09-29/tidb-dm-syncer.html">TiDB DM 数据库同步 STEP BY STEP</a></li>
                            <li><a href="https://blog.chenxiaosheng.com/posts/2022-05-07/debian-switch-kernel-boot.html">Debian 指定内核启动</a></li>
                            <li><a href="https://blog.chenxiaosheng.com/posts/2017-11-15/ntes-offers.html">网易游戏 MySQL-MongoDB 运维及 DBA 招聘</a></li>
                            <li><a href="https://blog.chenxiaosheng.com/posts/2019-09-07/mysql-large-seconds_behind_master.html">MySQL Seconds_Behind_Master 忽大忽小？莫慌</a></li>
                    </ul>
                <div class="panel-about row">
                  <div class="panel-author-avatar col-md-2 hidden-xs hidden-sm">
                    <img src="/static/avatar.gif" class="img-circle">
                  </div>
                  <div class="panel-author-description col-md-7">
                    <h4 class="icon-user"> 关于我</h4></br>
                    热爱开源、分享。目前主要从事 MongoDB、MySQL、Redis 等数据库私有云 SaaS 相关运维、开发工作。</br>
                    <br/>
                    <a href="https://www.vultr.com/?ref=6820888" class="hidden-xs hidden-sm"><img src="https://www.vultr.com/media/banner_2.png" width="468" height="60"></a>
                  </div>
                  <div class="panel-author-description col-md-3 hidden-xs hidden-sm">
                    <img src="/static/qrcode.jpg" width="160" height="160"></a>
                  </div>
                </div>
            </div>
            <!-- /.entry-content -->
    <hr />
    <section class="comments hidden-xs hidden-sm well well-sm" id="comments">
        <h2>相关评论</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'stutiredboy'; // required: replace example with your forum shortname
            var disqus_identifier = 'https://blog.chenxiaosheng.com/posts/2019-10-12/tidb-time_zone-settings.html';
            var disqus_url = 'https://blog.chenxiaosheng.com/posts/2019-10-12/tidb-time_zone-settings.html';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-md-3 col-lg-3 hidden-xs hidden-sm well well-sm" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
            <!-- NOTIFICATION START -->
            <div class="bs-callout bs-callout-info">
              <p>记录和整理自己的经验，仅供自己参考。若恰好对你有用，也算是功德一件。@<a href="http://www.zhihu.com" target="blank">知乎</a></p>
              <p>系统最后一次生成时间：2022-05-08 12:57:04</p>
            </div>
            <!-- NOTIFICATION END -->
            <!-- SOCIAL START -->
            <!--
                <li class="list-group-item">
                <span class="span-group-item"><a href="http://weibo.com/stutiredboy"><i class="icon-weibo icon-large"></i></a></span>
                <span class="span-group-item"><a href="https://www.facebook.com/stutiredboy"><i class="icon-facebook icon-large"></i></a></span>
                <span class="span-group-item"><a href="https://twitter.com/stutiredboy"><i class="icon-twitter icon-large"></i></a></span>
                <span class="span-group-item"><a href="https://github.com/stutiredboy"><i class="icon-github icon-large"></i></a></span>
                <span class="span-group-item"><a href="https://blog.chenxiaosheng.com/feeds/all.atom.xml"><i class="icon-rss icon-large"></i></a></span>
                </li>
            -->
            <!-- SOCIAL END -->
            <!-- CONTACT START -->
            <li class="list-group-item"><h4><i class="icon-envelope icon-large"></i>微信公众号</h4></li>
            <div class="text-center"><img src="/static/qrcode.jpg" alt="欢迎关注个人微信公众号" class="img-rounded"></div>
            <!-- CONTACT END -->
            <!-- TAGS CLOUD START -->
            <li class="list-group-item"><a href="https://blog.chenxiaosheng.com/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/wireshark.html">wireshark</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/openvpn.html">openvpn</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/redis.html">redis</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/dns.html">dns</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/scribe.html">scribe</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/linux.html">linux</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/sftp.html">sftp</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/arp.html">arp</a></span>
                <span class="tag-4"><a href="https://blog.chenxiaosheng.com/tag/mongodb.html">mongodb</a></span>
                <span class="tag-4"><a href="https://blog.chenxiaosheng.com/tag/django.html">django</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/iterm2.html">iterm2</a></span>
                <span class="tag-4"><a href="https://blog.chenxiaosheng.com/tag/dm.html">dm</a></span>
                <span class="tag-1"><a href="https://blog.chenxiaosheng.com/tag/mysql.html">mysql</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/replication.html">replication</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/netease.html">netease</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/pip.html">pip</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/sshd.html">sshd</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/openid.html">openid</a></span>
                <span class="tag-4"><a href="https://blog.chenxiaosheng.com/tag/pingcap.html">pingcap</a></span>
                <span class="tag-2"><a href="https://blog.chenxiaosheng.com/tag/java.html">java</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/securefx.html">secureFX</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/okr.html">okr</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/named.html">named</a></span>
                <span class="tag-4"><a href="https://blog.chenxiaosheng.com/tag/osx.html">osx</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/windows.html">windows</a></span>
                <span class="tag-2"><a href="https://blog.chenxiaosheng.com/tag/debian.html">debian</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/kernel.html">kernel</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/apache.html">apache</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/yosemite.html">yosemite</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/proxy.html">proxy</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/lxc.html">lxc</a></span>
                <span class="tag-4"><a href="https://blog.chenxiaosheng.com/tag/tidb.html">tidb</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/rate-limit.html">rate limit</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/ssh.html">ssh</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/wifi.html">wifi</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/http.html">http</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/dba.html">dba</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/jinja.html">jinja</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/ios.html">ios</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/dig.html">dig</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/tcpdump.html">tcpdump</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/syncer.html">syncer</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/grub.html">grub</a></span>
                <span class="tag-2"><a href="https://blog.chenxiaosheng.com/tag/mac.html">mac</a></span>
                <span class="tag-4"><a href="https://blog.chenxiaosheng.com/tag/bind.html">bind</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/cgroups.html">cgroups</a></span>
                <span class="tag-1"><a href="https://blog.chenxiaosheng.com/tag/python.html">python</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/crontab.html">crontab</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/post.html">post</a></span>
                <span class="tag-4"><a href="https://blog.chenxiaosheng.com/tag/ssl.html">ssl</a></span>
                <span class="tag-8"><a href="https://blog.chenxiaosheng.com/tag/pelican.html">pelican</a></span>
            <!-- TAGS CLOUD END -->
            <li class="list-group-item"><h4><i class="icon-comment icon-large"></i>最新评论</h4></li>
            <script type="text/javascript" src="https://stutiredboy.disqus.com/recent_comments_widget.js?num_items=8&hide_avatars=0&avatar_size=40&excerpt_length=200"></script>
            <!-- Uncomment if you want to show Social
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="http://weibo.com/stutiredboy"><i
                            class="icon-weibo-sign icon-large"></i>weibo
                    </a></li>
                    <li class="list-group-item"><a href="https://www.facebook.com/stutiredboy"><i
                            class="icon-facebook-sign icon-large"></i>facebook
                    </a></li>
                    <li class="list-group-item"><a href="https://twitter.com/stutiredboy"><i
                            class="icon-twitter-sign icon-large"></i>twitter
                    </a></li>
                    <li class="list-group-item"><a href="https://github.com/stutiredboy"><i
                            class="icon-github-sign icon-large"></i>github
                    </a></li>
                    <li class="list-group-item"><a href="https://blog.chenxiaosheng.com/feeds/all.atom.xml"><i
                            class="icon-rss-sign icon-large"></i>rss
                    </a></li>
            -->



        </ul>
    </section>
</aside>
</script>        </div>
    </div>
</div>

<script src="https://cdn.staticfile.org/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.chenxiaosheng.com/theme/js/respond.min.js"></script>
<!-- Footer Start -->
<footer class="footer">
  <div class="container">
    <p class="text-right visible-xs">&copy; 2018 ChenXiaosheng</p>
    <p class="text-right hidden-xs">&copy; 2018 ChenXiaosheng • 基于 <a href="http://docs.getpelican.com">Pelican</a> - <a href="http://www.python.org">Python</a> - <a href="http://jinja.pocoo.org/">Jinja</a> - <a href="http://getbootstrap.com">Bootstrap</a> - <a href="http://github.com">Github</a> - MarkDown 构建</p>
    <p class="text-right hidden-xs">除非另有声明，本网站采用<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh">署名-非商业性使用-禁止演绎 4.0 国际 (CC BY-NC-ND 4.0)</a>授权</p>
  </div>
</footer>
<!-- Footer End -->
</body>
</html>